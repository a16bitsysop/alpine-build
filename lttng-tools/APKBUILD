# Contributor: Michael Jeanson <mjeanson@efficios.com>
# Maintainer: Michael Jeanson <mjeanson@efficios.com>
pkgname=lttng-tools
pkgver=2.13.1
pkgrel=0
pkgdesc="LTTng 2.0 control and utility programs"
url="https://lttng.org"
arch="all !mips !mips64" # Due to babeltrace
license="GPL-2.0-only LGPL-2.1-only"
depends="babeltrace"
depends_dev="kmod-dev libxml2-dev lttng-ust-dev popt-dev userspace-rcu-dev
	util-linux-dev"
makedepends="$depends_dev autoconf automake bash coreutils grep libtool"
checkdepends="util-linux"
subpackages="$pkgname-dbg $pkgname-static $pkgname-dev $pkgname-doc"
source="https://lttng.org/files/lttng-tools/lttng-tools-$pkgver.tar.bz2
    unistd.patch
	test.patch
	"

prepare() {
    default_prepare
    autoreconf -fi
}

build() {
	unset LDFLAGS
	CFLAGS="$CFLAGS -O0 -g"
	CXXFLAGS="$CXXFLAGS -O0 -g"
	# We patch Makefile.am
	./configure \
		--build=$CBUILD \
		--host=$CHOST \
		--prefix=/usr \
		--sysconfdir=/etc \
		--localstatedir=/var
	make V=1
}

check() {
	# only run ubnit tests. all tests takes too much time
#	make -j1 -C tests/unit check
	./tests/unit/test_event_rule
}

package() {
	make DESTDIR="$pkgdir" install
	mkdir -p "$pkgdir"/usr/share/licenses/$pkgname
	mv "$pkgdir"/usr/share/doc/$pkgname/LICENSE \
		"$pkgdir"/usr/share/licenses/$pkgname/
}

sha512sums="489468a5dd01356fc7da8cc0d5788976f1009faf8d26ac3915100e341f5fe91e697c32ef2ce61a6ff88aad604d2fcfc2ce0f574dc5d2327852e69c00dcdb1313 lttng-tools-2.13.1.tar.bz2"
